<div class="card mt-3">
  <div class="card-body">
    <div class="panel panel-success pt-2">
      <div class="panel-heading">
        <h5 class="panel-title mt-3">Metadata</h5>
        <h6 class="card-subtitle mb-2 text-muted">
          Define metadata of the project used to generate predictions
        </h6>
        <h6 class="card-subtitle mb-2">
          Functional dependencies, keys and composite keys can be automatically
          find using profiling techniques.
        </h6>
      </div>
      <form [formGroup]="form" novalidate>
        <!-- Primary keys -->
        <div class="row table-dataset">
          <div class="d-flex align-items-end mb-2 mt-3">
            <h5 class="panel-title mt-3 card-text">Primary Keys</h5>
            <div class="d-grid gap-2 col-2 ms-auto">
              <button
                class="btn btn-outline-primary btn-sm btn-cust"
                type="button"
                (click)="findPks()"
              >
                Find
              </button>
            </div>
          </div>
          <div class="col-md-12 overflow-auto">
            <table
              border="1"
              class="table table-sm table-striped table-bordered table-hover text-center table-ck"
            >
              <thead>
                <tr>
                  <th class="column-id">#</th>
                  <th *ngFor="let h of scenario?.attributes" scope="col">
                    {{ h.name }}
                  </th>
                  <th class="column-id"></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>PK</td>
                  <td *ngFor="let h of scenario?.attributes">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [value]="h.normalizedName"
                      [checked]="primaryKeys.normalizedName == h.normalizedName"
                      formArrayName="selectedPk"
                      (change)="onPkChange($event)"
                    />
                  </td>
                  <td>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      type="button"
                      (click)="saveScenario()"
                    >
                      Save
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Composite Keys -->
        <div class="row table-dataset">
          <div class="d-flex align-items-end mb-2 mt-3">
            <h5 class="panel-title mt-3 card-text">Composite Keys</h5>
            <div class="d-grid gap-2 col-2 ms-auto">
              <button
                class="btn btn-outline-primary btn-sm btn-cust"
                type="button"
                (click)="findCks()"
              >
                Find
              </button>
            </div>
          </div>
          <div class="col-md-12 overflow-auto" style="max-height: 400px;">
            <table
              border="1"
              class="table table-sm table-striped table-bordered table-hover text-center table-ck"
            >
              <thead>
                <tr>
                  <th class="column-id">#</th>
                  <th *ngFor="let h of scenario?.attributes" scope="col">
                    {{ h.name }}
                  </th>
                  <th class="column-id"></th>
                </tr>
              </thead>
              <tbody>
                <tr
                  class="row-pk"
                  *ngFor="let item of scenario?.compositeKeys; let i = index"
                  [attr.data-index]="i"
                >
                  <td>{{ "CK" + (i + 1) }}</td>
                  <td *ngFor="let h of scenario?.attributes">
                    <i
                      *ngIf="includeCompositeKeys(i, h.normalizedName)"
                      class="fas fa-link"
                      style="color: orange"
                    ></i>
                  </td>
                  <td>
                    <button
                      class="btn btn-outline-danger btn-sm"
                      type="button"
                      (click)="deleteCk(i)"
                    >
                      Delete
                    </button>
                  </td>
                </tr>
                <tr>
                  <td></td>
                  <td *ngFor="let h of scenario?.attributes">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [value]="h.normalizedName"
                      formArrayName="selectedCompositeKeys"
                      (change)="onCkChange($event)"
                    />
                  </td>
                  <td>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      type="button"
                      (click)="addCk()"
                    >
                      Add
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Functional dependencies -->
        <div class="row table-dataset">
          <div class="d-flex align-items-end mb-2 mt-3">
            <h5 class="panel-title mt-3 card-text">Functional dependencies</h5>
            <div class="d-grid gap-2 col-2 ms-auto">
              <button
                class="btn btn-outline-primary btn-sm btn-cust"
                type="button"
                (click)="findFds()"
              >
                Find
              </button>
            </div>
          </div>
          <div class="col-md-12 overflow-auto" style="max-height: 400px;">
            <table
              border="1"
              class="table table-sm table-striped table-bordered table-hover text-center table-fd"
            >
              <thead>
                <tr>
                  <th class="column-id">#</th>
                  <th *ngFor="let h of scenario?.attributes" scope="col">
                    {{ h.name }}
                  </th>
                  <th class="column-id col-arrow"></th>
                  <th class="column-id col-attr"></th>
                  <th class="column-id col-words"></th>
                  <th class="column-id col-btn"></th>
                </tr>
              </thead>
              <tbody>
                <tr
                  class="row-pk"
                  *ngFor="let item of scenario?.fds; let i = index"
                  [attr.data-index]="i"
                >
                  <td>{{ "FD" + (i + 1) }}</td>
                  <td *ngFor="let h of scenario?.attributes">
                    <i
                      *ngIf="includeFunctionalDependencies(i, h.normalizedName)"
                      class="fas fa-check"
                      style="color: orange"
                    ></i>
                  </td>
                  <td class="col-arrow">
                    <i class="fas fa-arrow-right" style="color: orange"></i>
                  </td>
                  <td class="col-attr">
                    {{ getAttrDependency(i) }}
                  </td>
                  <td class="col-words">
                    {{ this.scenario!.fds[i][1].toString() }}
                  </td>
                  <td class="col-btn">
                    <button
                      class="btn btn-outline-danger btn-sm"
                      type="button"
                      (click)="deleteFd(i)"
                    >
                      Delete
                    </button>
                  </td>
                </tr>
                <tr>
                  <td></td>
                  <td *ngFor="let h of scenario?.attributes">
                    <input
                      class="form-check-input"
                      type="checkbox"
                      [value]="h.normalizedName"
                      formArrayName="selectedFds"
                      (change)="onFdChange($event)"
                    />
                  </td>
                  <td>
                    <i class="fas fa-arrow-right" style="color: orange"></i>
                  </td>
                  <td>
                    <select
                      class="form-select"
                      aria-label="Default select example"
                      style="width: fit-content"
                      (change)="onFdDependencyChange($event)"
                    >
                      <option
                        [value]=""
                        [disabled]="true"
                        [selected]="true"
                      ></option>
                      <option
                        *ngFor="let h of scenario?.attributes"
                        [value]="h.normalizedName"
                        [disabled]="includeAttrDependency(h.normalizedName)"
                        [selected]="
                          newFdDependency?.normalizedName == h.normalizedName
                        "
                      >
                        {{ h.name }}
                      </option>
                    </select>
                  </td>
                  <td>
                    <input class="form-control" formControlName="fdAttr" />
                  </td>
                  <td>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      type="button"
                      (click)="addFd()"
                    >
                      Add
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Templates -->
<div class="card mt-3 card-template">
  <div class="card-body">
    <h5 class="card-title">Template</h5>
    <h6 class="card-subtitle mb-2 text-muted">A-Query template</h6>
    <p class="card-text">
      Ambiguity Templates (or A-Query Templates) are parameterized queries used
      to generate SQL scripts. The parameters identify the elements of the query
      and can be assigned to <em>relation</em> and <em>attribute names</em>, a
      set of <em>labels</em> and <em>comparison operators</em>. Parameter values
      are automatically populated by Pythia using profiling methods and machine
      learning modules to find attributes ambiguities with the corresponding
      ambiguous words.
    </p>
    <form class="row g-3">
      <div class="input-group mb-3">
        <select class="form-select" id="select-templ">
          <option selected>Select a query template...</option>
          <option value="1">Attribute Ambiguity</option>
          <option value="2">Row Ambiguity</option>
          <option value="3">FD Ambiguity</option>
          <option value="4">Blank</option>
        </select>
        <button
          class="btn btn-outline-primary"
          type="button"
          onclick="javascript:show_element('card-t' + document.getElementById('select-templ').selectedIndex)"
        >
          Add
        </button>
      </div>
    </form>
    <div
      *ngFor="let t of templates; let indexOfelement = index"
      class="code-editor"
      id="card-t1"
    >
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
          <button
            class="accordion-button collapsed"
            type="button"
            data-bs-toggle="collapse"
            [attr.data-bs-target]="'#collapse' + indexOfelement"
            aria-expanded="true"
            [aria-controls]="'#collapse' + indexOfelement"
          >
            {{ t[3] }}
            <em style="margin-left: 10px">(Default Template)</em>
          </button>
        </h2>
        <div
          [attr.id]="'collapse' + indexOfelement"
          class="accordion-collapse collapse"
          aria-labelledby="headingOne"
          data-bs-parent="#accordionExample"
        >
          <div class="accordion-body">
            <div class="row">
              <label class="col-sm-2 col-form-label">Template Name</label>
              <div class="col-sm-10">
                <input
                  class="form-control"
                  type="text"
                  placeholder="Template Name"
                  aria-label="default input example"
                  [(ngModel)]="t[3]"
                />
              </div>
            </div>
            <div class="row g-3">
              <div style="height: 150px" class="col-12">
                <textarea
                  placeholder="Insert template sql"
                  id="editing"
                  spellcheck="false"
                  [(ngModel)]="t[0]"
                  (input)="updateSqlText(indexOfelement)"
                >
                {{ t[0] }}</textarea
                >
                <pre id="highlighting" aria-hidden="true" class="language-sql">
                  <code #highlightingContent class="language-sql" id="highlighting-content">{{ t[0] }}</code>
                </pre>
              </div>
              <div *ngIf="getOperators(t[1]).length > 0" class="col-12">
                <h6>Operators</h6>
                <div
                  class="row my-1"
                  *ngFor="let o of getOperators(t[1]); let i = index"
                >
                  <label
                    class="col-sm-1 col-form-label text-center font-weight-bold"
                    >{{ o }}</label
                  >
                  <div class="col-sm-6">
                    <input
                      class="form-control"
                      type="text"
                      placeholder="Template Name"
                      aria-label="default input example"
                      [(ngModel)]="t[2][i]"
                    />
                  </div>
                </div>
              </div>
              <div class="d-grid gap-2 col-2 ms-auto">
                <button
                  class="btn btn-outline-secondary btn-sm btn-cust"
                  type="button"
                  (click)="saveTemplates()"
                >
                  Save
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<form [formGroup]="formAmbiguous" novalidate>
  <div class="card mt-3 card-ambiguous">
    <div class="card-body">
      <h5 class="card-title">Ambiguous Attributes</h5>
      <h6 class="card-subtitle mb-2 text-muted">
        Define ambiguous attribute pairs
      </h6>
      <div class="row mb-3">
        <p class="col-9 card-text">
          Finds ambiguous attributes pairs with T5 model. It is possible to edit
          labels, or add new pairs. You can also submit ambiguous pairs as
          training data and retrain the T5 model <br /><em
            >Note: the process is asynchronous and may require some minutes to
            be completed</em
          >.
        </p>
        <div class="col-3">
          <button
            class="col-12 btn btn-outline-primary btn-sm btn-cust mb-2"
            type="button"
            (click)="findAmbiguous()"
          >
            Find
          </button>
          <!-- <button class="col-12 btn btn-primary btn-sm btn-cust" type="button">
          Submit & Train
        </button> -->
        </div>
      </div>
      <div class="row">
        <div class="cxol-md-8">
          <div class="panel panel-success">
            <table
              style="table-layout: fixed"
              border="1"
              class="table table-sm table-striped table-bordered table-hover text-center"
            >
              <thead>
                <tr>
                  <th>Attribute 1</th>
                  <th>Attribute 2</th>
                  <th>Label</th>
                  <th class="column-button"></th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let a of scenario?.ambiguousAttribute">
                  <td>{{ a[0].name }}</td>
                  <td>{{ a[1].name }}</td>
                  <td>{{ a[2] }}</td>
                  <td>
                    <button class="btn btn-outline-danger btn-sm" type="button">
                      Delete
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <select
                      class="form-select"
                      aria-label="Default select example"
                      style="width: fit-content"
                      (change)="onAmbiguousAttrChange($event, 0)"
                    >
                      <option
                        [value]=""
                        [disabled]="true"
                        [selected]="true"
                      ></option>
                      <option
                        *ngFor="let h of scenario?.attributes"
                        [value]="h.normalizedName"
                      >
                        {{ h.name }}
                      </option>
                    </select>
                  </td>
                  <td>
                    <select
                      class="form-select"
                      aria-label="Default select example"
                      style="width: fit-content"
                      (change)="onAmbiguousAttrChange($event, 1)"
                    >
                      <option
                        [value]=""
                        [disabled]="true"
                        [selected]="true"
                      ></option>
                      <option
                        *ngFor="let h of scenario?.attributes"
                        [value]="h.normalizedName"
                      >
                        {{ h.name }}
                      </option>
                    </select>
                  </td>
                  <td>
                    <input
                      class="form-control"
                      formControlName="ambiguousLabel"
                    />
                  </td>
                  <td>
                    <button
                      class="btn btn-outline-secondary btn-sm"
                      (click)="addAmbiguous()"
                      type="button"
                    >
                      Add
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>
